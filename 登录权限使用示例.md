# 登录权限系统使用示例

## 快速开始

### 1. 用户登录

用户可以通过两种方式登录：

#### 方式一：账号密码登录

```javascript
// 在 pages/login/login.js 中
// 用户输入用户名和密码后，系统会：
// 1. 验证用户名和密码
// 2. 查询数据库获取用户信息
// 3. 生成token并保存登录状态
// 4. 跳转到首页
```

#### 方式二：微信一键登录

```javascript
// 在 pages/login/login.js 中
// 用户点击微信登录后，系统会：
// 1. 调用微信登录API获取用户信息
// 2. 在数据库中创建或更新用户记录
// 3. 保存登录状态
// 4. 跳转到首页
```

### 2. 访问受保护的功能

登录后，用户可以：

#### 创建个人旅行计划

```javascript
// 在 index/index.js 中
async createManualPlan() {
  // ✅ 自动检查登录状态
  if (!Auth.requireLogin()) {
    return // 未登录会自动跳转到登录页
  }

  const userId = Auth.getCurrentUserId() // 获取当前用户ID

  const newPlan = {
    title: '我的云南之旅',
    destination: '云南',
    // ⚠️ 注意：不需要手动设置user_id，数据库操作会自动添加
  }

  // ✅ 使用db对象创建行程，会自动设置为当前用户
  const result = await db.travelPlans.create(newPlan)
  
  if (result.error) {
    wx.showToast({ title: '创建失败', icon: 'none' })
  } else {
    wx.showToast({ title: '创建成功', icon: 'success' })
  }
}
```

#### 查看个人旅行计划

```javascript
// 在 index/index.js 中
loadUserTravelPlans() {
  const userId = Auth.getCurrentUserId()
  
  if (!userId) {
    console.log('用户未登录')
    return
  }

  // ✅ 只查询当前用户的行程
  supabase
    .from('travel_plans')
    .select('*')
    .eq('user_id', userId)  // 关键：只查询当前用户的数据
    .then((result) => {
      // 处理结果
    })
}
```

#### 使用AI功能

```javascript
// 在 index/index.js 中
async aiPlanItinerary() {
  // ✅ 检查登录状态
  if (!Auth.requireLogin()) {
    return // 未登录会自动提示并跳转
  }

  const userId = Auth.getCurrentUserId()

  // 调用AI服务
  const result = await aiIntegration.planIntelligentItinerary(
    userId,  // 传入当前用户ID
    userInput
  )
}
```

### 3. 权限验证示例

#### 示例1：编辑行程前验证权限

```javascript
async editPlan(planId) {
  // 获取行程详情
  const result = await db.travelPlans.getById(planId)
  
  if (result.error) {
    // ❌ 无权访问或行程不存在
    wx.showToast({ 
      title: result.error.message || '无权访问', 
      icon: 'none' 
    })
    return
  }

  // ✅ 有权限，继续编辑
  const plan = result.data
  // 执行编辑操作...
}
```

#### 示例2：删除行程前验证权限

```javascript
async deletePlan(planId) {
  wx.showModal({
    title: '确认删除',
    content: '确定要删除这个行程吗？',
    success: async (res) => {
      if (res.confirm) {
        // ✅ delete方法会自动验证权限
        const result = await db.travelPlans.delete(planId)
        
        if (result.error) {
          wx.showToast({ title: '删除失败', icon: 'none' })
        } else {
          wx.showToast({ title: '删除成功', icon: 'success' })
          this.loadUserTravelPlans() // 刷新列表
        }
      }
    }
  })
}
```

### 4. 用户退出登录

```javascript
// 在 index/index.js 中
logout() {
  wx.showModal({
    title: '确认退出',
    content: '确定要退出登录吗？',
    success: (res) => {
      if (res.confirm) {
        // ✅ 使用Auth工具清除登录信息
        Auth.clearUserLogin()

        // 清空页面数据
        this.setData({ 
          userInfo: null,
          myTravelPlans: [],
          // ...
        })

        wx.showToast({ title: '已退出登录', icon: 'success' })
      }
    }
  })
}
```

## 常见问题

### Q1: 如何检查用户是否登录？

```javascript
// 方法1：简单检查
if (Auth.isLoggedIn()) {
  console.log('用户已登录')
}

// 方法2：要求登录（未登录会自动跳转）
if (!Auth.requireLogin()) {
  return
}
```

### Q2: 如何获取当前用户信息？

```javascript
// 获取完整用户信息
const userInfo = Auth.getCurrentUser()
console.log(userInfo.name, userInfo.avatar)

// 只需要用户ID
const userId = Auth.getCurrentUserId()
```

### Q3: 为什么我不能访问其他用户的数据？

```javascript
// ❌ 错误示例：尝试访问其他用户的数据
const otherUserId = 999
const result = await db.travelPlans.getByUserId(otherUserId)
// 结果：{ data: [], error: { message: '无权访问' } }

// ✅ 正确示例：只访问自己的数据
const currentUserId = Auth.getCurrentUserId()
const result = await db.travelPlans.getByUserId(currentUserId)
// 结果：成功返回当前用户的行程
```

### Q4: 如何在WXML中根据登录状态显示内容？

```xml
<!-- 登录后显示 -->
<view wx:if="{{userInfo}}">
  <text>欢迎，{{userInfo.name}}</text>
  <button bindtap="createPlan">创建行程</button>
</view>

<!-- 未登录显示 -->
<view wx:else>
  <button bindtap="goToLogin">请先登录</button>
</view>
```

### Q5: 创建数据时需要手动设置user_id吗？

```javascript
// ❌ 不需要！以下写法是错误的
const newPlan = {
  user_id: Auth.getCurrentUserId(),  // 不需要手动设置
  title: '新行程'
}

// ✅ 正确写法：user_id会自动添加
const newPlan = {
  title: '新行程',
  destination: '目的地'
  // user_id会由db.travelPlans.create()自动添加
}

const result = await db.travelPlans.create(newPlan)
```

### Q6: 如何防止用户篡改数据？

系统已自动实现了以下安全措施：

```javascript
// 1. 创建数据时强制使用当前用户ID
const result = await db.travelPlans.create({
  title: '新行程',
  user_id: 999  // ❌ 这个值会被忽略，强制使用当前用户ID
})

// 2. 更新数据时不允许修改user_id
const result = await db.travelPlans.update(planId, {
  title: '更新标题',
  user_id: 999  // ❌ 这个字段会被自动删除
})

// 3. 删除和查询时自动验证权限
const result = await db.travelPlans.delete(planId)
// 只有该行程的所有者才能删除
```

## 最佳实践

### ✅ DO - 推荐做法

```javascript
// 1. 总是使用Auth工具检查登录
if (!Auth.requireLogin()) return

// 2. 使用db对象操作数据，享受自动权限验证
const result = await db.travelPlans.create(data)

// 3. 检查操作结果
if (result.error) {
  console.error('操作失败:', result.error.message)
  return
}

// 4. 在页面onShow时检查登录状态
onShow() {
  const userInfo = Auth.getCurrentUser()
  this.setData({ userInfo })
}
```

### ❌ DON'T - 不推荐做法

```javascript
// 1. 不要直接访问全局变量
const user = app.globalData.userInfo  // ❌ 使用Auth.getCurrentUser()

// 2. 不要直接使用supabase操作用户数据
supabase.from('travel_plans').select('*')  // ❌ 使用db.travelPlans

// 3. 不要忘记检查登录状态
async doSomething() {
  const userId = Auth.getCurrentUserId()  // ❌ 应该先检查登录
  // 如果未登录，userId为null，会导致错误
}

// 4. 不要手动设置user_id
const data = { user_id: someId, ... }  // ❌ 会被自动覆盖
```

## 总结

通过使用本权限系统，你可以：

1. ✅ **自动验证用户登录状态** - 使用 `Auth.requireLogin()`
2. ✅ **自动过滤用户数据** - 使用 `db` 对象的方法
3. ✅ **防止越权访问** - 系统自动验证权限
4. ✅ **简化代码** - 无需手动添加user_id和权限检查
5. ✅ **提高安全性** - 多层防护机制

记住：**始终使用Auth和db工具，享受自动权限保护！**
